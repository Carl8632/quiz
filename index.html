<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—ç‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .hidden { display: none; }
        .option-correct { background-color: #22c55e !important; color: white !important; border-color: #16a34a !important; }
        .option-wrong { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 border border-slate-100">
        
        <div id="level-selection" class="space-y-6">
            <h1 class="text-3xl font-bold text-center text-indigo-600 mb-10">è‹±æ–‡å–®å­—æŒ‘æˆ°</h1>
            <div class="grid grid-cols-1 gap-5">
                <button id="btn-elementary" onclick="selectLevel('elementary')" class="py-5 bg-green-500 text-white rounded-2xl font-bold hover:bg-green-600 transition shadow-lg text-xl">åœ‹å°å–®å­—</button>
                <button id="btn-junior" onclick="selectLevel('junior')" class="py-5 bg-blue-500 text-white rounded-2xl font-bold hover:bg-blue-600 transition shadow-lg text-xl">åœ‹ä¸­å–®å­—</button>
                <button id="btn-senior" onclick="selectLevel('senior')" class="py-5 bg-purple-500 text-white rounded-2xl font-bold hover:bg-purple-600 transition shadow-lg text-xl">é«˜ä¸­å–®å­—</button>
            </div>
        </div>

        <div id="quiz-selection" class="hidden space-y-4">
            <button onclick="backToHome()" class="text-sm text-indigo-600 hover:underline mb-4">â† è¿”å›é‡é¸</button>
            <h2 id="selected-level-text" class="text-xl font-bold text-center text-slate-800 mb-6">å·²é¸æ“‡</h2>
            <button onclick="startQuiz('eng-to-chi')" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-md">è‹±æ–‡ â” ä¸­æ–‡ æ¸¬é©—</button>
            <button onclick="startQuiz('chi-to-eng')" class="w-full py-4 bg-white text-indigo-600 border-2 border-indigo-600 rounded-xl font-bold hover:bg-indigo-50 transition shadow-md">ä¸­æ–‡ â” è‹±æ–‡ æ¸¬é©—</button>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium">å¾—åˆ†: <span id="score">0</span></span>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-slate-500">è‡ªå‹•ç™¼éŸ³</span>
                    <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="auto-voice" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer outline-none transition-all duration-300 right-4 border-slate-300"/>
                        <label for="auto-voice" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-all duration-300"></label>
                    </div>
                </div>
            </div>
            
            <div id="question-container" class="text-center mb-8">
                <h2 id="question-text" class="text-4xl font-bold text-slate-800 mb-4 tracking-tight"></h2>
                <button onclick="speakWord()" class="px-4 py-2 bg-slate-100 rounded-full hover:bg-slate-200 transition text-sm text-slate-600 font-medium">ğŸ”Š é»æ“Šç™¼éŸ³</button>
                <div class="text-slate-400 text-xs mt-2">é€²åº¦: <span id="current-question-count">0</span>/10</div>
            </div>
            <div id="options-container" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="result-screen" class="hidden">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-slate-800">æ¸¬é©—çµæŸï¼</h2>
                <p class="text-slate-500 mt-2 text-xl">å¾—åˆ†ï¼š<span id="final-score" class="font-bold text-indigo-600">0</span></p>
            </div>
            <div class="mb-6">
                <h3 class="font-bold text-slate-700 mb-2 text-sm border-b pb-1">è¤‡ç¿’æ¸…å–®ï¼š</h3>
                <div id="review-list" class="space-y-1 max-h-52 overflow-y-auto pr-1"></div>
            </div>
            <button onclick="backToHome()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">å›ä¸»ç•«é¢</button>
        </div>
    </div>

    <script>
        // --- 1. åˆå§‹åŒ– (è¨˜å¾—è²¼ä¸Šä½ çš„æ­£ç¢º eyJ... Key) ---
        const SUPABASE_URL = 'https://zeqemounpcjbhbksftoa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplcWVtb3VucGNqYmhia3NmdG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NTI2NjIsImV4cCI6MjA4NzMyODY2Mn0.WAWfdmTygPQK3zJAeVO79pHKP7umHnFcouyykvT_x74'; 
        const myApp = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allWords = [];
        let shuffledVocabulary = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let quizResults = [];
        const totalQuestions = 10;
        let currentQuizType = 'eng-to-chi';
        let isAnswering = false;

        // --- 2. å°è¦½é‚è¼¯ ---
        function showScreen(screenId) {
            ['level-selection', 'quiz-selection', 'quiz-screen', 'result-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // ä¿®æ­£ï¼šå›åˆ°é¦–é ä¸¦æ¢å¾©ä½ è¦æ±‚çš„åŸå§‹æ–‡å­—
        function backToHome() {
            document.getElementById('btn-elementary').textContent = 'åœ‹å°å–®å­—';
            document.getElementById('btn-junior').textContent = 'åœ‹ä¸­å–®å­—';
            document.getElementById('btn-senior').textContent = 'é«˜ä¸­å–®å­—';
            showScreen('level-selection');
        }

        async function selectLevel(level) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'è¼‰å…¥ä¸­...';
            
            try {
                const { data, error } = await myApp.from('words').select('*').eq('level', level);
                if (error) throw error;
                allWords = data;
                
                const levelNames = { 'elementary': 'åœ‹å°å–®å­—', 'junior': 'åœ‹ä¸­å–®å­—', 'senior': 'é«˜ä¸­å–®å­—' };
                document.getElementById('selected-level-text').textContent = `å·²é¸æ“‡ï¼š${levelNames[level]}`;
                showScreen('quiz-selection');
            } catch (err) { 
                alert('é€£ç·šå¤±æ•—ï¼š' + err.message);
                btn.textContent = originalText;
            }
        }

        // --- 3. æ¸¬é©—é‚è¼¯ ---
        function startQuiz(quizType) {
            currentQuizType = quizType;
            currentQuestionIndex = 0;
            score = 0;
            quizResults = [];
            document.getElementById('score').textContent = score;
            shuffledVocabulary = [...allWords].sort(() => 0.5 - Math.random()).slice(0, totalQuestions);
            showScreen('quiz-screen');
            loadNextQuestion();
        }

        function loadNextQuestion() {
            if (currentQuestionIndex >= totalQuestions) {
                showResult();
                return;
            }
            isAnswering = false;
            const currentWord = shuffledVocabulary[currentQuestionIndex];
            document.getElementById('current-question-count').textContent = currentQuestionIndex + 1;
            document.getElementById('question-text').textContent = currentQuizType === 'eng-to-chi' ? currentWord.english : currentWord.chinese;
            
            if (document.getElementById('auto-voice').checked) {
                setTimeout(() => speakWord(), 100); 
            }

            let distractors = allWords.filter(w => w.english !== currentWord.english).sort(() => 0.5 - Math.random()).slice(0, 3);
            let options = [...distractors, currentWord].sort(() => 0.5 - Math.random());
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full py-4 px-6 text-left bg-slate-50 border-2 border-slate-100 rounded-xl transition font-medium";
                btn.textContent = currentQuizType === 'eng-to-chi' ? opt.chinese : opt.english;
                btn.onclick = () => handleAnswer(opt, btn, currentWord);
                container.appendChild(btn);
            });
        }

        function handleAnswer(selectedOpt, btn, correctWord) {
            if (isAnswering) return;
            isAnswering = true;
            const isCorrect = selectedOpt.english === correctWord.english;
            quizResults.push({ word: correctWord.english, chinese: correctWord.chinese, isCorrect: isCorrect });

            if (isCorrect) {
                btn.classList.add('option-correct');
                score += 10;
            } else {
                btn.classList.add('option-wrong');
                document.querySelectorAll('#options-container button').forEach(b => {
                    if ((currentQuizType === 'eng-to-chi' && b.textContent === correctWord.chinese) || 
                        (currentQuizType === 'chi-to-eng' && b.textContent === correctWord.english)) {
                        b.classList.add('option-correct');
                    }
                });
            }
            document.getElementById('score').textContent = score;

            setTimeout(() => {
                currentQuestionIndex++;
                loadNextQuestion();
            }, 500); // ç¶­æŒ 0.5 ç§’å¿«é€Ÿåæ‡‰
        }

        function showResult() {
            document.getElementById('final-score').textContent = score;
            const container = document.getElementById('review-list');
            container.innerHTML = '';
            quizResults.forEach(res => {
                const div = document.createElement('div');
                div.className = `flex justify-between p-2 rounded ${res.isCorrect ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'} text-xs`;
                div.innerHTML = `<span>${res.word} - ${res.chinese}</span><span>${res.isCorrect ? 'âœ“' : 'âœ—'}</span>`;
                container.appendChild(div);
            });
            showScreen('result-screen');
        }

        function speakWord() {
            const word = shuffledVocabulary[currentQuestionIndex]?.english;
            if (!word) return;
            const msg = new SpeechSynthesisUtterance(word);
            msg.lang = 'en-US';
            msg.rate = 0.9;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(msg);
        }
    </script>
</body>
</html>