<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å–®å­—ç‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
        .hidden { display: none; }
        .option-correct { background-color: #22c55e !important; color: white !important; border-color: #16a34a !important; }
        .option-wrong { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 border border-slate-100">
        
        <div id="level-selection" class="space-y-6">
            <h1 class="text-3xl font-bold text-center text-indigo-600 mb-4">è‹±æ–‡å–®å­—æŒ‘æˆ°</h1>
            
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-3">
                <p class="text-sm font-bold text-slate-600">ğŸ‘¤ å­¸ç”Ÿç™»å…¥</p>
                <div class="flex gap-2">
                    <input type="number" id="class-id" placeholder="åº§è™Ÿ" class="w-2/3 p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="stu-name" placeholder="è‹±æ–‡å" class="w-1/3 p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="loginAndLoad()" id="login-btn" class="w-full py-2 bg-slate-800 text-white rounded-xl text-sm font-bold">ç™»å…¥ä¸¦è®€å–ç´€éŒ„</button>
            </div>

            <div id="personal-error-container" class="hidden animate-fade-in">
                <h3 class="font-bold text-red-600 mb-2 flex justify-between items-center">
                    <span>ğŸ”¥ æˆ‘çš„æ­·å²éŒ¯é¡Œè¤‡ç¿’</span>
                    <span id="error-count-tag" class="text-xs bg-red-100 px-2 py-1 rounded text-red-600">0 å­—</span>
                </h3>
                <div id="error-list-content" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1 bg-red-50 rounded-xl border border-red-100">
                    </div>
                <button onclick="startErrorQuiz()" class="w-full mt-3 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 shadow-md">é–‹å§‹éŒ¯é¡Œè¡åˆºæ¨¡å¼</button>
            </div>

            <div id="level-buttons" class="grid grid-cols-1 gap-3 pt-4 border-t border-slate-100">
                <p class="text-xs text-slate-400 font-bold">é¸æ“‡å–®å­—åº«é–‹å§‹æ–°æ¸¬é©—ï¼š</p>
                <button onclick="selectLevel('elementary')" class="py-4 bg-green-500 text-white rounded-2xl font-bold shadow-lg">åœ‹å°å–®å­—</button>
                <button onclick="selectLevel('junior')" class="py-4 bg-blue-500 text-white rounded-2xl font-bold shadow-lg">åœ‹ä¸­å–®å­—</button>
                <button onclick="selectLevel('senior')" class="py-4 bg-purple-500 text-white rounded-2xl font-bold shadow-lg">é«˜ä¸­å–®å­—</button>
            </div>
        </div>

        <div id="quiz-selection" class="hidden space-y-4 text-center">
            <button onclick="backToHome()" class="text-sm text-indigo-600 hover:underline">â† è¿”å›é¦–é </button>
            <h2 id="welcome-msg" class="text-lg font-bold text-slate-700"></h2>
            <div class="space-y-3">
                <button onclick="startQuiz('eng-to-chi')" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-md">ä¸€èˆ¬ï¼šè‹± â” ä¸­</button>
                <button onclick="startQuiz('chi-to-eng')" class="w-full py-4 bg-white text-indigo-600 border-2 border-indigo-600 rounded-xl font-bold">ä¸€èˆ¬ï¼šä¸­ â” è‹±</button>
            </div>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <button onclick="confirmExit()" class="text-xs bg-slate-200 px-3 py-1 rounded-full text-slate-600 hover:bg-red-100 hover:text-red-600 transition">âœ• çµæŸæ¸¬é©—</button>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-slate-500">è‡ªå‹•ç™¼éŸ³</span>
                    <label class="relative inline-block w-10 h-6">
                        <input type="checkbox" id="auto-voice" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer right-4 border-slate-300"/>
                        <span class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></span>
                    </label>
                </div>
            </div>
            <div class="text-center mb-8">
                <h2 id="question-text" class="text-4xl font-bold text-slate-800 mb-4"></h2>
                <button onclick="speakWord()" class="px-4 py-2 bg-slate-100 rounded-full text-sm">ğŸ”Š é»æ“Šç™¼éŸ³</button>
                <div class="text-slate-400 text-xs mt-4">å¾—åˆ†: <span id="score">0</span> | é€²åº¦: <span id="current-question-count">0</span><span id="total-count-text">/10</span></div>
            </div>
            <div id="options-container" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="result-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">æ¸¬é©—çµæŸï¼</h2>
            <p class="text-slate-500 text-xl mb-6">å¾—åˆ†ï¼š<span id="final-score" class="font-bold text-indigo-600">0</span></p>
            <button onclick="loginAndLoad()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">å›é¦–é è¤‡ç¿’éŒ¯é¡Œ</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zeqemounpcjbhbksftoa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplcWVtb3VucGNqYmhia3NmdG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NTI2NjIsImV4cCI6MjA4NzMyODY2Mn0.WAWfdmTygPQK3zJAeVO79pHKP7umHnFcouyykvT_x74'; 
        const myApp = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allWords = [];
        let shuffledVocabulary = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let studentId = "";
        let isReviewingErrors = false;
        let isAnswering = false;

        // --- ç™»å…¥ä¸¦è®€å–æ­·å²éŒ¯é¡Œ ---
        async function loginAndLoad() {
            const classVal = document.getElementById('class-id').value;
            const nameVal = document.getElementById('stu-name').value;
            if (!classVal || !nameVal) return alert("è«‹è¼¸å…¥å®Œæ•´ç™»å…¥è³‡è¨Šï¼");

            studentId = `${classVal}_${nameVal}`;
            document.getElementById('login-btn').textContent = "è®€å–ä¸­...";

            const { data, error } = await myApp.from('user_errors').select('word, chinese').eq('student_id', studentId);
            
            if (!error) {
                const content = document.getElementById('error-list-content');
                content.innerHTML = '';
                const unique = Array.from(new Set(data.map(a => JSON.stringify(a)))).map(a => JSON.parse(a));
                
                if (unique.length > 0) {
                    unique.forEach(d => {
                        const item = document.createElement('div');
                        item.className = "text-[10px] p-2 bg-white rounded border border-red-100 shadow-sm";
                        item.innerHTML = `<b class="text-red-600">${d.word}</b><br>${d.chinese}`;
                        content.appendChild(item);
                    });
                    document.getElementById('error-count-tag').textContent = `${unique.length} å­—`;
                    document.getElementById('personal-error-container').classList.remove('hidden');
                } else {
                    document.getElementById('personal-error-container').classList.add('hidden');
                }
            }
            document.getElementById('login-btn').textContent = "é‡æ–°è®€å–ç´€éŒ„";
            showScreen('level-selection');
        }

        async function selectLevel(level) {
            if (!studentId) return alert("è«‹å…ˆå®Œæˆç™»å…¥ï¼");
            const { data } = await myApp.from('words').select('*').eq('level', level);
            allWords = data;
            document.getElementById('welcome-msg').textContent = `æº–å‚™å¥½æ¸¬é©—äº†å—ï¼Ÿ`;
            showScreen('quiz-selection');
        }

        function startQuiz(type) {
            isReviewingErrors = false;
            shuffledVocabulary = [...allWords].sort(() => 0.5 - Math.random()).slice(0, 10);
            initQuizUI();
        }

        async function startErrorQuiz() {
            const { data } = await myApp.from('user_errors').select('word, chinese').eq('student_id', studentId);
            if (!data || data.length === 0) return;

            const unique = [];
            const seen = new Set();
            data.forEach(d => {
                if(!seen.has(d.word)) {
                    seen.add(d.word);
                    unique.push({ english: d.word, chinese: d.chinese });
                }
            });

            isReviewingErrors = true;
            shuffledVocabulary = unique.sort(() => 0.5 - Math.random());
            initQuizUI();
        }

        function initQuizUI() {
            currentQuestionIndex = 0; score = 0;
            document.getElementById('score').textContent = score;
            document.getElementById('total-count-text').textContent = `/${shuffledVocabulary.length}`;
            showScreen('quiz-screen');
            loadNextQuestion();
        }

        function loadNextQuestion() {
            if (currentQuestionIndex >= shuffledVocabulary.length) return showResult();
            isAnswering = false;
            const current = shuffledVocabulary[currentQuestionIndex];
            document.getElementById('current-question-count').textContent = currentQuestionIndex + 1;
            document.getElementById('question-text').textContent = current.english;
            if (document.getElementById('auto-voice').checked) setTimeout(() => speakWord(), 100);

            let distractors = allWords.length > 4 ? allWords.filter(w => w.english !== current.english).sort(() => 0.5 - Math.random()).slice(0, 3) : [];
            let options = [...distractors, current].sort(() => 0.5 - Math.random());
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full py-4 px-6 text-left bg-slate-50 border-2 border-slate-100 rounded-xl font-medium";
                btn.textContent = opt.chinese;
                btn.onclick = () => handleAnswer(opt, btn, current);
                container.appendChild(btn);
            });
        }

        async function handleAnswer(selected, btn, correct) {
            if (isAnswering) return;
            isAnswering = true;
            const isCorrect = selected.english === correct.english;
            
            if (isCorrect) {
                btn.classList.add('option-correct');
                score += 10;
                // å¦‚æœæ˜¯éŒ¯é¡Œæ¨¡å¼ä¸”ç­”å°ï¼Œå‰‡åˆªé™¤ç´€éŒ„
                if (isReviewingErrors) {
                    await myApp.from('user_errors').delete().eq('student_id', studentId).eq('word', correct.english);
                }
            } else {
                btn.classList.add('option-wrong');
                await myApp.from('user_errors').insert([{ student_id: studentId, word: correct.english, chinese: correct.chinese }]);
                document.querySelectorAll('#options-container button').forEach(b => {
                    if (b.textContent === correct.chinese) b.classList.add('option-correct');
                });
            }
            setTimeout(() => { currentQuestionIndex++; loadNextQuestion(); }, 700);
        }

        function confirmExit() {
            if (confirm("ç¢ºå®šè¦å›é¦–é å—ï¼Ÿ")) backToHome();
        }

        function showResult() {
            document.getElementById('final-score').textContent = score;
            showScreen('result-screen');
        }

        function speakWord() {
            const word = shuffledVocabulary[currentQuestionIndex]?.english;
            if (word) {
                const msg = new SpeechSynthesisUtterance(word);
                msg.lang = 'en-US';
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(msg);
            }
        }

        function showScreen(id) {
            ['level-selection', 'quiz-selection', 'quiz-screen', 'result-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function backToHome() { loginAndLoad(); }
    </script>
</body>
</html>