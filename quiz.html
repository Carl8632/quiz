<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªå¥½ç°¡å–®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
        .hidden { display: none; }
        .option-correct { background-color: #22c55e !important; color: white !important; border-color: #16a34a !important; }
        .option-wrong { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 border border-slate-100">
        
        <div id="level-selection" class="space-y-6">
            <button onclick="window.location.href='index.html'" class="text-sm text-indigo-600 hover:underline">â† è¿”å›å¤§å»³</button>
            <h1 class="text-3xl font-bold text-center text-indigo-600">è‹±èªå¥½ç°¡å–®</h1>
            
            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 space-y-3">
                <p class="text-sm font-bold text-slate-600 flex items-center">ğŸ‘¤ å­¸ç”Ÿç™»å…¥</p>
                <div class="flex gap-2">
                    <input type="number" id="class-id" placeholder="ç­ç´šåº§è™Ÿ" class="w-2/3 p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="stu-name" placeholder="è‹±æ–‡å" class="w-1/3 p-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <button onclick="loginAndLoad()" id="login-btn" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-md hover:bg-slate-700 transition">ç™»å…¥ä¸¦è®€å–ç´€éŒ„</button>
            </div>

            <div id="personal-error-container" class="hidden bg-red-50 p-4 rounded-2xl border border-red-100">
                <h3 class="font-bold text-red-600 mb-2 flex justify-between items-center text-sm">
                    <span>ğŸ”¥ æ­·å²éŒ¯é¡Œè¤‡ç¿’ (ç­”å°è‡ªå‹•ç§»é™¤)</span>
                </h3>
                <div id="error-list-content" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto custom-scrollbar p-1 text-black"></div>
                <button onclick="startErrorQuiz()" class="w-full mt-3 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 shadow-lg">é€²å…¥éŒ¯é¡Œè¡åˆºæ¨¡å¼</button>
            </div>

            <div id="level-buttons" class="grid grid-cols-1 gap-3 pt-4 border-t border-slate-100">
                <button onclick="selectLevel('elementary')" class="py-4 bg-green-500 text-white rounded-2xl font-bold shadow-lg hover:bg-green-600 transition text-lg">åœ‹å°åŸºç¤</button>
                <button onclick="selectLevel('junior')" class="py-4 bg-blue-500 text-white rounded-2xl font-bold shadow-lg hover:bg-blue-600 transition text-lg">åœ‹ä¸­å¿…å‚™</button>
                <button onclick="selectLevel('senior')" class="py-4 bg-purple-500 text-white rounded-2xl font-bold shadow-lg hover:bg-purple-600 transition text-lg">é«˜ä¸­æ ¸å¿ƒ</button>
            </div>
        </div>

        <div id="quiz-selection" class="hidden space-y-6 text-center">
            <button onclick="showScreen('level-selection')" class="text-sm text-indigo-600 hover:underline">â† è¿”å›é¸æ“‡ç­‰ç´š</button>
            <h2 id="welcome-msg" class="text-xl font-bold text-slate-700"></h2>
            <div class="space-y-4">
                <button onclick="startQuiz('eng-to-chi')" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-bold shadow-xl hover:bg-indigo-700">è‹± â” ä¸­ æ¸¬é©—</button>
                <button onclick="startQuiz('chi-to-eng')" class="w-full py-5 bg-white text-indigo-600 border-2 border-indigo-600 rounded-2xl font-bold hover:bg-indigo-50">ä¸­ â” è‹± æ¸¬é©—</button>
            </div>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button onclick="confirmExit()" class="text-xs bg-slate-200 px-3 py-1.5 rounded-full text-slate-600 font-bold">âœ• çµæŸæ¸¬é©—</button>
                <div class="flex items-center space-x-2">
                    <span class="text-[10px] text-slate-400 font-bold">è‡ªå‹•ç™¼éŸ³</span>
                    <label class="relative inline-block w-10 h-6">
                        <input type="checkbox" id="auto-voice" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer right-4 border-slate-300"/>
                        <span class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></span>
                    </label>
                </div>
            </div>
            <div class="text-center mb-10">
                <h2 id="question-text" class="text-5xl font-bold text-slate-800 mb-6"></h2>
                <button onclick="speakWord()" class="px-6 py-2 bg-indigo-50 text-indigo-600 rounded-full text-sm font-bold border border-indigo-100">ğŸ”Š è½è²éŸ³</button>
                <div class="text-slate-400 text-xs mt-6 font-bold">å¾—åˆ†: <span id="score" class="text-indigo-600">0</span></div>
            </div>
            <div id="options-container" class="grid grid-cols-1 gap-4"></div>
        </div>

        <div id="result-screen" class="hidden text-center">
            <div class="py-10">
                <span class="text-6xl mb-4 block">ğŸ‰</span>
                <h2 class="text-3xl font-bold text-slate-800 mb-2">æ¸¬é©—çµæŸï¼</h2>
                <p class="text-slate-500 text-xl font-bold">å¾—åˆ†ï¼š<span id="final-score" class="text-indigo-600">0</span></p>
            </div>
            <button onclick="loginAndLoad()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg hover:bg-indigo-700">å›åˆ°æ¸¬é©—é¦–é </button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zeqemounpcjbhbksftoa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplcWVtb3VucGNqYmhia3NmdG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NTI2NjIsImV4cCI6MjA4NzMyODY2Mn0.WAWfdmTygPQK3zJAeVO79pHKP7umHnFcouyykvT_x74'; 
        const myApp = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allWords = [];
        let shuffledVocabulary = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let studentId = "";
        let isReviewingErrors = false;
        let isAnswering = false;
        let currentQuizType = "";

        async function loginAndLoad() {
            const classVal = document.getElementById('class-id').value;
            const nameVal = document.getElementById('stu-name').value;
            if (!classVal || !nameVal) return alert("è«‹å®Œæˆç™»å…¥è³‡æ–™å¡«å¯«");

            studentId = `${classVal}_${nameVal}`;
            document.getElementById('login-btn').textContent = "è®€å–ä¸­...";

            const { data, error } = await myApp.from('user_errors').select('word, chinese').eq('student_id', studentId);
            
            if (!error) {
                const content = document.getElementById('error-list-content');
                content.innerHTML = '';
                const unique = Array.from(new Set(data.map(a => JSON.stringify(a)))).map(a => JSON.parse(a));
                
                if (unique.length > 0) {
                    unique.forEach(d => {
                        const item = document.createElement('div');
                        item.className = "text-[11px] p-2 bg-white rounded-xl border border-red-100 shadow-sm text-center";
                        item.innerHTML = `<b class="text-red-600 block mb-1">${d.word}</b><span class="text-black font-medium">${d.chinese}</span>`;
                        content.appendChild(item);
                    });
                    document.getElementById('personal-error-container').classList.remove('hidden');
                } else {
                    document.getElementById('personal-error-container').classList.add('hidden');
                }
            }
            document.getElementById('login-btn').textContent = "åˆ·æ–°ç´€éŒ„æˆåŠŸ";
            showScreen('level-selection');
        }

        async function selectLevel(level) {
            if (!studentId) return alert("è«‹å…ˆå®Œæˆç™»å…¥");
            const { data } = await myApp.from('words').select('*').eq('level', level);
            allWords = data;
            document.getElementById('welcome-msg').textContent = `æº–å‚™å¥½æŒ‘æˆ°äº†å—ï¼Ÿ`;
            showScreen('quiz-selection');
        }

        function startQuiz(type) {
            isReviewingErrors = false;
            shuffledVocabulary = [...allWords].sort(() => 0.5 - Math.random()).slice(0, 10);
            initQuizUI(type);
        }

        async function startErrorQuiz() {
            const { data } = await myApp.from('user_errors').select('word, chinese').eq('student_id', studentId);
            if (!data || data.length === 0) return alert("ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ï¼");

            const unique = [];
            const seen = new Set();
            data.forEach(d => {
                if(!seen.has(d.word)) {
                    seen.add(d.word);
                    unique.push({ english: d.word, chinese: d.chinese });
                }
            });

            isReviewingErrors = true;
            shuffledVocabulary = unique.sort(() => 0.5 - Math.random());
            initQuizUI('eng-to-chi');
        }

        function initQuizUI(type) {
            currentQuizType = type;
            currentQuestionIndex = 0; score = 0;
            document.getElementById('score').textContent = score;
            showScreen('quiz-screen');
            loadNextQuestion();
        }

        function loadNextQuestion() {
            if (currentQuestionIndex >= shuffledVocabulary.length) return showResult();
            isAnswering = false;
            const current = shuffledVocabulary[currentQuestionIndex];
            document.getElementById('question-text').textContent = currentQuizType === 'eng-to-chi' ? current.english : current.chinese;
            
            if (document.getElementById('auto-voice').checked) setTimeout(() => speakWord(), 100);

            let distractors = allWords.filter(w => w.english !== current.english).sort(() => 0.5 - Math.random()).slice(0, 3);
            let options = [...distractors, { english: current.english, chinese: current.chinese }].sort(() => 0.5 - Math.random());
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full py-4 px-6 text-left bg-slate-50 border-2 border-slate-100 rounded-2xl font-bold transition-all text-black hover:bg-slate-100";
                btn.textContent = currentQuizType === 'eng-to-chi' ? opt.chinese : opt.english;
                btn.onclick = () => handleAnswer(opt, btn, current);
                container.appendChild(btn);
            });
        }

        async function handleAnswer(selected, btn, correct) {
            if (isAnswering) return;
            isAnswering = true;
            const isCorrect = selected.english === (correct.english || correct.word);
            
            if (isCorrect) {
                btn.classList.add('option-correct');
                score += 10;
                if (isReviewingErrors) {
                    await myApp.from('user_errors').delete().eq('student_id', studentId).eq('word', correct.english || correct.word);
                }
            } else {
                btn.classList.add('option-wrong');
                await myApp.from('user_errors').insert([{ student_id: studentId, word: correct.english || correct.word, chinese: correct.chinese }]);
                document.querySelectorAll('#options-container button').forEach(b => {
                    const correctText = currentQuizType === 'eng-to-chi' ? correct.chinese : (correct.english || correct.word);
                    if (b.textContent === correctText) b.classList.add('option-correct');
                });
            }
            setTimeout(() => { currentQuestionIndex++; loadNextQuestion(); }, 700);
        }

        function confirmExit() { if (confirm("çµæŸæ¸¬é©—ä¸¦å›åˆ°é¦–é ï¼Ÿ")) backToHome(); }
        function showResult() { document.getElementById('final-score').textContent = score; showScreen('result-screen'); }
        function speakWord() {
            const word = shuffledVocabulary[currentQuestionIndex]?.english || shuffledVocabulary[currentQuestionIndex]?.word;
            if (word) {
                const msg = new SpeechSynthesisUtterance(word);
                msg.lang = 'en-US';
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(msg);
            }
        }
        function showScreen(id) {
            ['level-selection', 'quiz-selection', 'quiz-screen', 'result-screen'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function backToHome() { window.location.href = 'index.html'; }
    </script>
</body>
</html>